@{
    ViewData["Title"] = "Leaflet Route Planner";
    Layout = "_Layout";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    #map {
        width: 100%;
        height: 650px;
        border-radius: 8px;
    }

    .panel {
        background: #ffffff;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .result-box {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin-top: 10px;
    }
</style>

<div class="container-fluid mt-4">
    <div class="row">

        <!-- LEFT CONTROL PANEL -->
        <div class="col-md-4">
            <div class="panel">
                <h4>üó∫ Route Planner (Leaflet)</h4>
                <p class="text-muted">OpenStreetMap based routing</p>

                <div class="mb-3">
                    <label class="form-label">From</label>
                    <input id="origin" class="form-control" placeholder="Enter starting place" />
                </div>

                <div class="mb-3">
                    <label class="form-label">To</label>
                    <input id="destination" class="form-control" placeholder="Enter destination" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Departure Time</label>
                    <input id="departureTime" type="datetime-local" class="form-control" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Travel Mode</label>
                    <select id="mode" class="form-select">
                        <option value="driving">üöó Driving</option>
                        <option value="cycling">üö¥ Cycling</option>
                        <option value="walking">üö∂ Walking</option>
                    </select>
                </div>

                <button class="btn btn-primary w-100" onclick="calculateRoute()">
                    üîç Search Route
                </button>

                <div id="result" class="result-box"></div>
            </div>
        </div>

        <!-- MAP -->
        <div class="col-md-8">
            <div id="map"></div>
        </div>

    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let routeLayer;
    let startMarker;
    let endMarker;

    // Init map
    map = L.map('map').setView([1.3521, 103.8198], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    async function geocode(place) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.length === 0) {
            throw "Location not found";
        }

        return {
            lat: parseFloat(data[0].lat),
            lon: parseFloat(data[0].lon),
            name: data[0].display_name
        };
    }

    async function calculateRoute() {

        const originText = document.getElementById("origin").value;
        const destText = document.getElementById("destination").value;
        const mode = document.getElementById("mode").value;
        const departureInput = document.getElementById("departureTime").value;

        if (!originText || !destText) {
            alert("Please enter both origin and destination.");
            return;
        }

        if (!departureInput) {
            alert("Please select a departure time.");
            return;
        }

        try {
            const start = await geocode(originText);
            const end = await geocode(destText);

            // Remove old layers
            if (routeLayer) map.removeLayer(routeLayer);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);

            startMarker = L.marker([start.lat, start.lon]).addTo(map).bindPopup("Start").openPopup();
            endMarker = L.marker([end.lat, end.lon]).addTo(map).bindPopup("Destination");

            const url = `https://router.project-osrm.org/route/v1/${mode}/${start.lon},${start.lat};${end.lon},${end.lat}?overview=full&geometries=geojson`;

            const res = await fetch(url);
            const json = await res.json();

            const route = json.routes[0];

            routeLayer = L.geoJSON(route.geometry, {
                style: {
                    color: "blue",
                    weight: 5,
                    opacity: 0.8
                }
            }).addTo(map);

            map.fitBounds(routeLayer.getBounds());

            // Distance & duration
            const distanceKm = (route.distance / 1000).toFixed(2);
            const durationSec = route.duration;
            const durationMin = (durationSec / 60).toFixed(1);

            // Arrival time calculation
            const departureTime = new Date(departureInput);
            const arrivalTime = new Date(departureTime.getTime() + durationSec * 1000);

            const arrivalTimeStr = arrivalTime.toLocaleString([], {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById("result").innerHTML = `
                <h6>üìä Route Information</h6>
                <p><strong>Distance:</strong> ${distanceKm} km</p>
                <p><strong>Estimated Travel Time:</strong> ${durationMin} minutes</p>
                <p><strong>Estimated Arrival Time:</strong> ${arrivalTimeStr}</p>
            `;

        } catch (e) {
            alert("Failed to calculate route.");
        }
    }
</script>

